<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>日常花费</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="apple-touch-icon" href="icon-512.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
        margin: 16px;
    }
    h2 { margin-bottom: 10px; }
    label { font-size: 14px; margin-top: 8px; display: block; }
    input, button {
        padding: 8px;
        margin-top: 4px;
        width: 100%;
        box-sizing: border-box;
        font-size: 14px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        font-size: 13px;
    }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 6px; text-align: left; }

    /* 新增：记录颜色 */
    .row-new {
        background-color: #ffe5e5;   /* 浅红色：未导出 */
    }
    .row-exported {
        background-color: #e5ffe5;   /* 浅绿色：已导出 */
    }

    .delete-button {
        background: #cc0000; color: white; border: none;
        padding: 4px 8px; border-radius: 4px; cursor: pointer;
    }
    .category-buttons {
        display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px;
    }
    .category-button {
        flex: 0 0 auto; padding: 6px 10px; border-radius: 6px; border: none;
        background: #cc0000; color: white; font-size: 13px; cursor: pointer;
    }
    .category-button.selected { background: #008000; }
</style>
</head>

<body>

<h2>日常花费（€）</h2>

<label>日期：</label>
<input type="date" id="date">

<label>金额（欧元，逗号为小数点，例如 12,50）：</label>
<input type="text" id="amount" inputmode="decimal" placeholder="例如：12,50">

<label>费用分类：</label>
<div id="categoryButtons" class="category-buttons">
    <button type="button" class="category-button" data-category="花费-外出吃饭">花费-外出吃饭</button>
    <button type="button" class="category-button" data-category="花费-超市买菜">花费-超市买菜</button>
    <button type="button" class="category-button" data-category="花费-日常用品">花费-日常用品</button>
    <button type="button" class="category-button" data-category="花费-电器家具">花费-电器家具</button>
    <button type="button" class="category-button" data-category="花费-衣服购物">花费-衣服购物</button>
    <button type="button" class="category-button" data-category="花费-交通出行">花费-交通出行</button>
    <button type="button" class="category-button" data-category="花费-乐乐学习">花费-乐乐学习</button>
</div>

<button type="button" onclick="addRecord()">添加记录</button>
<button type="button" onclick="exportCSV()">导出 CSV（仅导出未导出记录）</button>

<table id="recordsTable">
    <thead>
        <tr>
            <th>日期 (dd-MM-yyyy)</th>
            <th>金额 (€)</th>
            <th>分类</th>
            <th>状态</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
const STORAGE_KEY = "cash_records_simple_v2";

let storageAvailable = true;
try { localStorage.setItem("__t__", "1"); localStorage.removeItem("__t__"); }
catch(e){ storageAvailable = false; }

let inMemory = [];
let selectedCategory = "";

// 工具函数
function setToday() {
    const today = new Date().toISOString().slice(0, 10);
    if (!document.getElementById("date").value)
        document.getElementById("date").value = today;
}

function formatGermanDate(iso) {
    const p = iso.split("-");
    return `${p[2]}-${p[1]}-${p[0]}`;
}

function loadRecords() {
    if (!storageAvailable) return inMemory;
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
    catch(e){ return inMemory; }
}

function saveRecords(r) {
    if (!storageAvailable) { inMemory = r; return; }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(r));
}

// 分类按钮
function initCategoryButtons() {
    document.querySelectorAll(".category-button").forEach(btn=>{
        btn.onclick = function(){
            selectedCategory = (selectedCategory === btn.dataset.category ? "" : btn.dataset.category);
            updateCategoryButtonStyles();
        };
    });
}

function updateCategoryButtonStyles() {
    document.querySelectorAll(".category-button").forEach(btn=>{
        btn.classList.toggle("selected", btn.dataset.category === selectedCategory);
    });
}

// 添加记录
function addRecord() {
    const isoDate = date.value;
    let raw = amount.value;
    if (!isoDate) return alert("请选择日期");
    if (!raw) return alert("请输入金额");

    raw = raw.replace(",", ".");
    const num = parseFloat(raw);
    if (isNaN(num)) return alert("格式错误，例如 12,50");

    const category = selectedCategory || "未分类";
    const amountValue = -Math.abs(num);

    const records = loadRecords();
    records.unshift({
        isoDate,
        amount: amountValue,
        category,
        exported: false       // 新增字段：未导出
    });

    saveRecords(records);
    amount.value = "";
    render();
}

// 删除
function deleteRecord(i) {
    const r = loadRecords();
    r.splice(i,1);
    saveRecords(r);
    render();
}

// 渲染
function render() {
    const r = loadRecords();
    const tbody = document.querySelector("#recordsTable tbody");
    tbody.innerHTML = "";

    r.forEach((item, i) => {
        const tr = document.createElement("tr");

        tr.className = item.exported ? "row-exported" : "row-new";

        tr.innerHTML = `
            <td>${formatGermanDate(item.isoDate)}</td>
            <td>${item.amount.toFixed(2)}</td>
            <td>${item.category}</td>
            <td>${item.exported ? "已导出" : "未导出"}</td>
            <td><button class="delete-button">删除</button></td>
        `;

        tr.querySelector("button").onclick = () => deleteRecord(i);
        tbody.appendChild(tr);
    });
}

// 导出 CSV：只导出未导出的
function exportCSV() {
    const all = loadRecords();
    const newOnes = all.filter(r => !r.exported);

    if (newOnes.length === 0) {
        alert("没有新的记录需要导出。");
        return;
    }

    let csv = "日期,月份,金额 (€),花费种类\n";

    newOnes.forEach(r=>{
        const g = formatGermanDate(r.isoDate);
        const m = parseInt(r.isoDate.split("-")[1],10);
        csv += `"${g}","${m}","${r.amount}","${r.category}"\n`;
    });

    const blob = new Blob([csv], { type:"text/csv" });

    // iPhone Safari: share sheet
    if (navigator.share) {
        const file = new File([blob], "cash_records.csv", { type:"text/csv" });

        navigator.share({
            title: "日常花费记录",
            files: [file]
        })
        .then(() => {
            // 导出成功 → 所有新记录变绿色
            all.forEach(r => { if (!r.exported) r.exported = true; });
            saveRecords(all);
            render();
        })
        .catch(err=>{
            console.log("Share failed:", err);
            fallbackDownload(blob, all);
        });

    } else {
        fallbackDownload(blob, all);
    }
}

function fallbackDownload(blob, all){
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "cash_records.csv";
    a.click();

    all.forEach(r => { if (!r.exported) r.exported = true; });
    saveRecords(all);
    render();
}

// 初始化
window.addEventListener("DOMContentLoaded", ()=>{
    setToday();
    initCategoryButtons();
    render();
});
</script>

</body>
</html>
