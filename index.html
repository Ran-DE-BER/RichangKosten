<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>日常花费</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="apple-touch-icon" href="icon-512.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
        margin: 16px;
    }
    h2 { margin-bottom: 10px; }
    label { font-size: 14px; margin-top: 8px; display: block; }
    input, button {
        padding: 8px;
        margin-top: 4px;
        width: 100%;
        box-sizing: border-box;
        font-size: 14px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        font-size: 13px;
    }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 6px; text-align: left; }
    .delete-button {
        background: #cc0000; color: white; border: none;
        padding: 4px 8px; border-radius: 4px; cursor: pointer;
    }
    .category-buttons {
        display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px;
    }
    .category-button {
        flex: 0 0 auto; padding: 6px 10px; border-radius: 6px; border: none;
        background: #cc0000; color: white; font-size: 13px; cursor: pointer;
    }
    .category-button.selected { background: #008000; }
</style>
</head>

<body>

<h2>日常花费（€）</h2>

<label>日期：</label>
<input type="date" id="date">

<label>金额（欧元，使用逗号作为小数点，例如：12,50）：</label>
<input type="text" id="amount" placeholder="例如：12,50">

<label>费用分类：</label>
<div id="categoryButtons" class="category-buttons">
    <button type="button" class="category-button" data-category="花费-外出吃饭">花费-外出吃饭</button>
    <button type="button" class="category-button" data-category="花费-超市买菜">花费-超市买菜</button>
    <button type="button" class="category-button" data-category="花费-日常用品">花费-日常用品</button>
    <button type="button" class="category-button" data-category="花费-电器家具">花费-电器家具</button>
    <button type="button" class="category-button" data-category="花费-衣服购物">花费-衣服购物</button>
    <button type="button" class="category-button" data-category="花费-交通出行">花费-交通出行</button>
    <button type="button" class="category-button" data-category="花费-乐乐学习">花费-乐乐学习</button>
</div>

<button type="button" onclick="addRecord()">添加记录</button>
<button type="button" onclick="exportCSV()">导出 CSV（分享 / 保存）</button>

<table id="recordsTable">
    <thead>
        <tr>
            <th>日期 (dd-MM-yyyy)</th>
            <th>金额 (€，负数)</th>
            <th>分类</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
// ===================== 保存设置 =====================
const STORAGE_KEY = "cash_records_simple";

let storageAvailable = true;
try { localStorage.setItem("__test__", "1"); localStorage.removeItem("__test__"); }
catch(e){ storageAvailable = false; }

let inMemoryRecords = [];

let selectedCategory = "";

// ===================== 工具 =====================
function setToday() {
    const t = new Date().toISOString().slice(0, 10);
    const d = document.getElementById("date");
    if (d && !d.value) d.value = t;
}

function formatGermanDate(iso) {
    const p = iso.split("-");
    if (p.length !== 3) return iso;
    return `${p[2]}-${p[1]}-${p[0]}`;
}

function loadRecords() {
    if (!storageAvailable) return inMemoryRecords;
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
    catch(e){ return inMemoryRecords; }
}

function saveRecords(r) {
    if (!storageAvailable) { inMemoryRecords = r; return; }
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(r)); }
    catch(e){ inMemoryRecords = r; }
}

// ===================== 分类按钮 =====================
function initCategoryButtons() {
    document.querySelectorAll(".category-button").forEach(btn=>{
        btn.onclick = function(){
            const cat = this.dataset.category;
            selectedCategory = (selectedCategory === cat ? "" : cat);
            updateCategoryButtonStyles();
        };
    });
}
function updateCategoryButtonStyles() {
    document.querySelectorAll(".category-button").forEach(btn=>{
        btn.classList.toggle("selected", btn.dataset.category === selectedCategory);
    });
}

// ===================== 主逻辑 =====================
function addRecord() {
    const isoDate = document.getElementById("date").value;
    const raw = document.getElementById("amount").value;

    if (!isoDate) return alert("请选择日期");
    if (!raw) return alert("请输入金额");

    const value = raw.replace(",", ".");
    const num = parseFloat(value);
    if (isNaN(num)) return alert("金额格式不正确，例如 12,50");

    const amount = -Math.abs(num);
    const category = selectedCategory || "未分类";

    const list = loadRecords();
    list.unshift({ isoDate, amount, category });
    saveRecords(list);
    render();
    document.getElementById("amount").value = "";
}

function deleteRecord(i) {
    const r = loadRecords();
    r.splice(i, 1);
    saveRecords(r);
    render();
}

function render() {
    const r = loadRecords();
    const tbody = document.querySelector("#recordsTable tbody");
    tbody.innerHTML = "";

    r.forEach((item, i)=>{
        const tr = document.createElement("tr");

        tr.innerHTML = `
            <td>${formatGermanDate(item.isoDate)}</td>
            <td>${item.amount.toFixed(2)}</td>
            <td>${item.category}</td>
            <td><button class="delete-button">删除</button></td>
        `;
        tr.querySelector("button").onclick = ()=>deleteRecord(i);
        tbody.appendChild(tr);
    });
}

// ===================== 导出 CSV + 打开分享菜单 =====================
function exportCSV() {
    const records = loadRecords();
    if (records.length === 0) {
        alert("没有记录可以导出！");
        return;
    }

    let csv = "日期,月份,金额 (€),花费种类\n";

    records.forEach(r=>{
        const gDate = formatGermanDate(r.isoDate);
        const month = parseInt(r.isoDate.split("-")[1], 10);
        const cat = r.category.replace(/"/g,'""');

        csv += `"${gDate}","${month}","${r.amount}","${cat}"\n`;
    });

    const blob = new Blob([csv], {type:"text/csv"});
    const url = URL.createObjectURL(blob);

    // ----- iPhone Safari 自动打开 Share Sheet -----
    if (navigator.share) {
        const file = new File([blob], "cash_records.csv", { type: "text/csv" });

        navigator.share({
            title: "日常花费记录",
            text: "导出的 CSV 文件",
            files: [file]
        })
        .catch(err=>{
            console.log("Share 失败，使用下载方式", err);
            downloadFallback(url);
        });
    } else {
        downloadFallback(url);
    }
}

function downloadFallback(url){
    const a = document.createElement("a");
    a.href = url;
    a.download = "cash_records.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

window.addEventListener("DOMContentLoaded", ()=>{
    setToday();
    initCategoryButtons();
    render();
});
</script>

</body>
</html>
